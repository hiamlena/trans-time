<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Trans-Time — Маршрут для грузовиков</title>
  <meta name="description" content="Постройте оптимальный маршрут для грузовиков в России: вес, оси, via-точки, альтернативы и весовые рамки."/>
  <link rel="icon" href="/assets/logo-tt.png"/>

  <style>
    :root{ --bg:#0f1115; --panel:#151822; --muted:#8892a6; --text:#e6eaf2; --accent:#e11d2e; --stroke:#232836; --btn:#1b2030; --btn-h:#232a3d; }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    #app{display:grid;grid-template-rows:auto 1fr}
    header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,var(--panel),rgba(21,24,34,.8));border-bottom:1px solid var(--stroke);backdrop-filter:blur(6px)}
    .bar{max-width:1200px;margin:8px auto;padding:8px 12px;display:grid;gap:8px;grid-template-columns:1fr 1fr minmax(120px,auto) auto}
    .row2{display:flex;gap:8px;align-items:center;grid-column:1/-1}
    .brand{font-weight:700;letter-spacing:.3px}
    .field{background:var(--btn);border:1px solid var(--stroke);border-radius:10px;padding:8px 10px;display:flex;align-items:center;gap:8px}
    .field input{width:100%;background:transparent;border:0;outline:0;color:var(--text);font:14px/1.2 inherit}
    .pill{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--stroke);background:var(--btn);padding:6px 10px;border-radius:999px;cursor:pointer;user-select:none}
    .pill input{display:none}.pill.active{background:var(--btn-h);border-color:var(--accent)}
    .btn{background:var(--accent);border:0;color:#fff;font-weight:600;padding:10px 12px;border-radius:10px;cursor:pointer}
    .btn.secondary{background:var(--btn);color:var(--text);border:1px solid var(--stroke)}
    .small{font-size:12px;color:var(--muted)}
    #map{height:100%;width:100%}
    .legend{position:absolute;left:12px;bottom:12px;z-index:4;background:rgba(21,24,34,.9);border:1px solid var(--stroke);border-radius:12px;padding:8px 10px;display:flex;gap:10px;align-items:center}
    .legend .dot{width:10px;height:10px;border-radius:50%}
    .routeList{position:absolute;right:12px;top:90px;z-index:4;min-width:220px;max-width:300px;background:rgba(21,24,34,.95);border:1px solid var(--stroke);border-radius:12px;padding:8px;display:none}
    .routeItem{padding:8px;border-radius:10px;border:1px solid transparent;cursor:pointer}
    .routeItem:hover{background:var(--btn)}.routeItem.active{border-color:var(--accent);background:var(--btn-h)}
    .toast{position:fixed;right:12px;bottom:12px;z-index:10;background:rgba(21,24,34,.95);border:1px solid var(--stroke);box-shadow:0 6px 22px rgba(0,0,0,.35);padding:10px 14px;border-radius:12px;display:none}
    @media (max-width:900px){ .bar{grid-template-columns:1fr} .routeList{top:auto;bottom:90px;right:12px} }
  </style>

  <!-- Яндекс.Карты API — подключение строго один раз -->
  <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&amp;apikey=317aa42d-aa15-4acf-885a-6d6bfddb2339&amp;suggest_apikey=317aa42d-aa15-4acf-885a-6d6bfddb2339" defer></script>
</head>
<body>
<div id="app">
  <header>
    <div class="bar">
      <div class="brand">Trans-Time • Маршрут для грузовиков</div>
      <div class="small">Клик по карте ➜ добавить via-точку</div>
      <div></div>
      <div class="small" style="text-align:right">Альтернативы доступны — выберите в списке</div>

      <label class="field"><span>Откуда</span><input id="from" type="text" placeholder="Адрес, населённый пункт"></label>
      <label class="field"><span>Куда</span><input id="to" type="text" placeholder="Адрес, населённый пункт"></label>

      <div class="row2">
        <div id="vehicleGroup" style="display:flex;gap:8px;flex-wrap:wrap">
          <label class="pill active"><input type="radio" name="veh" value="car" checked><span>Легковой</span></label>
          <label class="pill"><input type="radio" name="veh" value="truck40"><span>Грузовой ≤ 40 т</span></label>
          <label class="pill"><input type="radio" name="veh" value="truckHeavy"><span>Грузовой &gt; 40 т</span></label>
        </div>
        <div style="display:flex;gap:8px;margin-left:auto">
          <button id="buildBtn" class="btn">Построить маршрут</button>
          <button id="clearVia" class="btn secondary">Сбросить via-точки</button>
        </div>
      </div>
    </div>
  </header>

  <div style="position:relative">
    <div id="map"></div>
    <div class="legend">
      <div class="dot" style="background:#22c55e"></div><span class="small">Маршрут</span>
      <div class="dot" style="background:#f59e0b"></div><span class="small">Альтернативы</span>
      <div class="dot" style="background:#60a5fa"></div><span class="small">Весовые рамки</span>
    </div>
    <div id="routeList" class="routeList"></div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
(function(){
  let map, multiRoute, viaPoints = [];
  let objectManager = null;

  const $ = s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
  const toastEl = $('#toast'), routeListEl = $('#routeList');

  const toast=(html,ms=4500)=>{
    toastEl.innerHTML=html;
    toastEl.style.display='block';
    clearTimeout(toastEl._t);
    toastEl._t=setTimeout(()=>toastEl.style.display='none',ms);
  };
  const setActivePill=v=> $$('#vehicleGroup .pill').forEach(p=>p.classList.toggle('active', p.querySelector('input').value===v));
  const getVehicle=()=> (document.querySelector('input[name="veh"]:checked')?.value)||'car';
  const routingMode=v=> v==='car' ? 'auto' : 'truck';
  const truckParams=v=> v==='truck40' ? {weight:40000} : (v==='truckHeavy' ? {weight:50000, axleCount:5} : null);
  const ESC = {
    "&":"&amp;",
    "<":"&lt;",
    ">":"&gt;",
    "\"":"&quot;",
    "'":"&#39;"
  };
  const escapeHtml=s=>String(s).replace(/[&<>"']/g,m=>ESC[m]||m);

  window.addEventListener('load',()=>{
    if(!window.ymaps){
      toast('Ошибка загрузки Яндекс.Карт. Проверьте CSP и ключ.');
      return;
    }
    ymaps.ready(init);
  });

  function init(){
    map = new ymaps.Map('map',{
      center:[55.751244,37.618423],
      zoom:8,
      controls:['zoomControl','geolocationControl','typeSelector','fullscreenControl']
    },{ suppressMapOpenBlock:true });

    new ymaps.SuggestView('from',{results:8,width:'auto'});
    new ymaps.SuggestView('to',{results:8,width:'auto'});

    $$('#vehicleGroup .pill input').forEach(r=>
      r.addEventListener('change',()=>{ setActivePill(r.value); if($('#from').value && $('#to').value) buildRoute(); })
    );

    map.events.add('click', e=>{
      const c = e.get('coords');
      if(confirm(`Добавить via-точку?\n${c[0].toFixed(6)}, ${c[1].toFixed(6)}`)){
        viaPoints.push(c);
        map.geoObjects.add(new ymaps.Placemark(c,{hintContent:'via-точка'},{preset:'islands#blueDotIcon'}));
        if($('#from').value && $('#to').value) buildRoute();
      }
    });

    $('#buildBtn').addEventListener('click', buildRoute);
    $('#clearVia').addEventListener('click', ()=>{
      viaPoints = [];
      const toRemove = [];
      map.geoObjects.each(o=>{ try{ if(o?.options?.get('preset')==='islands#blueDotIcon') toRemove.push(o);}catch(e){} });
      toRemove.forEach(o=>map.geoObjects.remove(o));
      if(multiRoute) buildRoute();
    });

    loadFrames();

    ['from','to'].forEach(id=> $('#'+id).addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); buildRoute(); }}));
  }

  async function geocodeToPoint(q){
    if(Array.isArray(q)) return q;
    const res = await ymaps.geocode(q,{results:1});
    const g = res.geoObjects.get(0);
    if(!g) throw new Error('Адрес не найден: '+q);
    return g.geometry.getCoordinates();
  }

  async function buildRoute(){
    const a=$('#from').value.trim(), b=$('#to').value.trim();
    if(!a||!b){ toast('Укажите <b>Откуда</b> и <b>Куда</b>.'); return; }
    try{
      const [A,B] = await Promise.all([geocodeToPoint(a), geocodeToPoint(b)]);
      const ref = [A, ...viaPoints, B];

      const params={results:3, routingMode:routingMode(getVehicle()), avoidTrafficJams:true};
      const t=truckParams(getVehicle()); if(t) params.truck=t;

      if(!multiRoute){
        multiRoute=new ymaps.multiRouter.MultiRoute({referencePoints:ref, params},{
          routeActiveStrokeWidth:6, routeActiveStrokeColor:'#22c55e',
          routeStrokeStyle:'solid', routeStrokeWidth:3, routeStrokeOpacity:.6, routeStrokeColor:'#f59e0b',
          wayPointStartIconFillColor:'#22c55e', wayPointFinishIconFillColor:'#ef4444', viaPointIconFillColor:'#60a5fa',
          wayPointDraggable:false, boundsAutoApply:true
        });
        map.geoObjects.add(multiRoute);
        multiRoute.model.events.add('requestsuccess', updateUI);
        multiRoute.events.add('activeroutechange', updateUI);
        multiRoute.model.events.add('requestfail', ()=> toast('Маршрут не построен. Проверьте адреса/тип ТС.', 6000));
      }else{
        multiRoute.model.setReferencePoints(ref);
        multiRoute.model.setParams(params, true);
      }

      if(objectManager){ try{ map.geoObjects.remove(objectManager);}catch(e){} map.geoObjects.add(objectManager); }

    }catch(e){ console.warn(e); toast('Не удалось построить маршрут. Проверьте адреса.', 5000); }
  }

  function fmtDist(m){ return (m/1000).toFixed(1).replace('.',',')+' км'; }
  function fmtTime(s){ const h=(s/3600)|0, m=Math.round((s%3600)/60); return h?`${h} ч ${m} мин`:`${m} мин`; }

  function updateUI(){
    if(!multiRoute) return;
    const routes = multiRoute.getRoutes();
    if(!routes || routes.getLength()===0){ routeListEl.style.display='none'; toast('Маршрут не найден.', 3500); return; }
    const active = multiRoute.getActiveRoute();
    if(active){ const p=active.properties.getAll(); toast(`<b>Активный маршрут:</b> ${fmtDist(p?.distance?.value||0)} • ${fmtTime(p?.duration?.value||0)}`, 6000); }

    routeListEl.innerHTML='';
    for(let i=0;i<routes.getLength();i++){
      const r=routes.get(i), p=r.properties.getAll();
      const el=document.createElement('div');
      el.className='routeItem'+(r===active?' active':'');
      el.innerHTML=`<div><b>Вариант ${i+1}</b></div><div class="small">${fmtDist(p?.distance?.value||0)} • ${fmtTime(p?.duration?.value||0)}</div>`;
      el.addEventListener('click',()=>{ multiRoute.setActiveRoute(r); updateUI(); });
      routeListEl.appendChild(el);
    }
    routeListEl.style.display = routes.getLength()>1 ? 'block' : 'none';
  }

  async function loadFrames(){
    try{
      const resp = await fetch('data/frames_ready.geojson?v='+Date.now(), {cache:'no-store'});
      if(!resp.ok) throw new Error(resp.status+' '+resp.statusText);
      const data = await resp.json();

      objectManager = new ymaps.ObjectManager({clusterize:false, geoObjectOpenBalloonOnClick:true});
      objectManager.objects.options.set({preset:'islands#blueCircleDotIcon'});

      if(Array.isArray(data.features)){
        data.features = data.features.filter(f=>f?.geometry?.type==='Point' && Array.isArray(f.geometry.coordinates));
        data.features.forEach(f=>{
          const p = f.properties || {};
          f.properties = {
            hintContent: p.name || 'Весовая рамка',
            balloonContent:
              `<div style="min-width:220px"><b>${escapeHtml(p.name||'Весовая рамка')}</b>${
                 p.comment?`<div style=\"margin-top:6px\">${escapeHtml(p.comment)}</div>`:''}${
                 p.date?`<div class=\"small\" style=\"margin-top:6px;color:#9aa3b2\">Дата: ${escapeHtml(p.date)}</div>`:''}</div>`
          };
        });
      }
      objectManager.add(data);
      map.geoObjects.add(objectManager);
    }catch(e){
      console.warn('frames_ready.geojson:', e);
      toast('Не удалось загрузить весовые рамки.', 4000);
    }
  }
})();
</script>
</body>
</html>
