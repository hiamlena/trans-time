<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TransTime — логистика</title>
<link rel="icon" href="/assets/logo-tt.png" />
<link rel="preload" href="/assets/ru-mask.png" as="image">
<style>
  :root{
    --bg:#0b0b0d; --fg:#ececec; --muted:#a0a0a0;
    --btn:#f2f2f2; --btnText:#111; --accent:#4da3ff;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    font-family:system-ui,-apple-system,Inter,Roboto,Arial;
    background:var(--bg); color:var(--fg);
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    text-align:center; position:relative; overflow:hidden;
  }

  /* MAP / MASK area */
  .map { position:absolute; inset:0; z-index:0; display:grid; place-items:center; pointer-events:none; }
  .map-box{
    position:absolute; inset:0; width:100%; height:100%;
    mask: url("/assets/ru-mask.png") center/contain no-repeat;
    -webkit-mask: url("/assets/ru-mask.png") center/contain no-repeat;
    opacity:.32;
  }
  /* ровный фон без центрального высветления */
  .map-bg{ position:absolute; inset:0; background:#141414; }
  canvas.layer{ position:absolute; inset:0; width:100%; height:100%; display:block; image-rendering:crisp-edges; }

  /* UI */
  .logo, h1, form, .bottom-links, .footer { position:relative; z-index:1; } /* поверх карты */
  .logo{ width:130px;height:130px;border-radius:50%;background:#000; display:grid; place-items:center; margin-bottom:26px; box-shadow:0 0 0 1px rgba(255,255,255,.18), 0 18px 48px rgba(0,0,0,.6); }
  .logo img{ width:84%; filter:invert(1) contrast(1.2) }
  h1{ font-size:42px; font-weight:800; letter-spacing:.02em; margin-bottom:18px; }
  form{ display:flex; flex-direction:column; width:100%; max-width:360px; margin:0 auto; }
  input{ background:#141418; border:1px solid #222; color:var(--fg); border-radius:10px; padding:12px 14px; margin-bottom:12px; font-size:15px; }
  input:focus{ outline:none; border-color:var(--accent); box-shadow:0 0 0 2px rgba(77,163,255,.18); }
  .btn{ padding:12px 0; border-radius:10px; background:var(--btn); color:var(--btnText); border:none; font-weight:700; cursor:pointer; }
  .bottom-links{ margin-top:18px; display:flex; flex-direction:column; align-items:center; gap:10px; }
  .link-btn{ padding:10px 24px; border-radius:10px; border:1px solid #2a2a2e; color:var(--fg); text-decoration:none; font-weight:600; background:#15161a }
  .footer{ margin-top:22px; color:var(--muted); font-size:13px; line-height:1.4; }
  @media(max-width:560px){ h1{font-size:30px} .logo{width:110px;height:110px} }
  @media (max-width: 768px) {
    .map-box { opacity: .4; mask-size: cover; -webkit-mask-size: cover; }
  }
</style>
</head>
<body>
  <!-- КАРТА -->
  <div class="map">
    <div class="map-box">
      <div class="map-bg"></div>
      <canvas id="lines" class="layer" aria-hidden="true"></canvas>
      <canvas id="fx" class="layer" aria-hidden="true"></canvas>
    </div>
  </div>

  <!-- UI -->
  <div class="logo"><img src="/assets/logo-tt.png" alt="ТТ"></div>
  <h1>ЛОГИСТИКА</h1>

  <form id="loginForm">
    <input id="login" type="text" placeholder="Логин" autocomplete="username">
    <input id="password" type="password" placeholder="Пароль" autocomplete="current-password">
    <button type="submit" class="btn">Войти</button>
  </form>

  <div class="bottom-links">
    <a href="/guest/" class="link-btn" id="demoLink">Демо-доступ</a>
    <a href="/register" style="font-size:14px;color:#888;text-decoration:none;">Зарегистрироваться</a>
  </div>

  <div class="footer">
    © TransTime. Цифровая платформа маршрутов, контроля и аналитики грузоперевозок.
  </div>

<script>
/* Нейроны по всей карте + яркая вспышка в конце */
const CFG = {
  MASK_SRC: '/assets/ru-mask.png',
  GRID_STEP_PX: 28,
  K_NEAREST: 6,
  MAX_POINTS: 1100,
  PARTICLES: (window.innerWidth < 560 ? 180 : 360),
  SPEED_MIN: 0.22,
  SPEED_MAX: 0.46,
  END_FLASH_RADIUS: 34,
  END_FLASH_FADE: 0.85,
  MAJOR_WEIGHT: 0.00
};

(() => {
  const lines = document.getElementById('lines');
  const fx    = document.getElementById('fx');
  const lctx  = lines.getContext('2d');
  const fctx  = fx.getContext('2d', { alpha: true });

  fctx.imageSmoothingEnabled = false;
  lctx.imageSmoothingEnabled = false;

  const DPR = Math.min(window.devicePixelRatio || 1, 2);

  function fitCanvas(c){
    const r = c.getBoundingClientRect();
    const w = Math.max(1, Math.floor(r.width * DPR));
    const h = Math.max(1, Math.floor(r.height * DPR));
    if (c.width !== w || c.height !== h){
      c.width = w; c.height = h;
      c.getContext('2d').setTransform(DPR,0,0,DPR,0,0);
    }
    return {w:r.width, h:r.height};
  }

  // маска
  const maskCanvas = document.createElement('canvas');
  const maskCtx = maskCanvas.getContext('2d');
  const maskImg = new Image();
  maskImg.src = CFG.MASK_SRC;

  // ориентиры (хабы)
  const HUBS = [
    {x:.12,y:.45},{x:.20,y:.38},{x:.18,y:.26},{x:.26,y:.47},{x:.31,y:.48},
    {x:.34,y:.53},{x:.37,y:.60},{x:.40,y:.53},{x:.44,y:.56},{x:.49,y:.55},
    {x:.56,y:.55},{x:.60,y:.58},{x:.68,y:.55},{x:.76,y:.58},{x:.91,y:.47},{x:.93,y:.58},
    {x:.25,y:.60},{x:.23,y:.64}
  ];
  const BACKBONE = [
    [1,3],[3,4],[4,5],[5,8],[8,9],[9,10],[10,11],[11,12],[12,13],[13,14],[14,15],
    [3,16],[16,17],[17,6]
  ];

  // геометрия/анимация
  let W=800, H=450, pts=[], edges=[], majors=[], curves=[];
  let particles=[], pulses=[];
  let ready=false;
  let edgeLoads=[]; // балансировка загрузки рёбер

  function insideMask(px,py){
    const d = maskCtx.getImageData(px|0, py|0, 1,1).data;
    return d[3] > 12;
  }
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));

  function controlPoint(A,B,alt){
    const x1=A.x, y1=A.y, x2=B.x, y2=B.y;
    const mx=(x1+x2)/2, my=(y1+y2)/2;
    const dx=x2-x1, dy=y2-y1, nx=-dy, ny=dx;
    const len=Math.hypot(nx,ny)||1;
    const bend=0.06*Math.hypot(dx,dy);
    return {x:mx+(nx/len)*bend*(alt?1:-1), y:my+(ny/len)*bend*(alt?1:-1)};
  }

  function precomputeCurves(){
    curves = [];
    const add = (i,j,alt,major=false) => {
      const A=pts[i], B=pts[j], C=controlPoint(A,B,alt);
      curves.push({ai:i, bi:j, A, B, C, major});
    };
    edges.forEach(([i,j],idx)=>add(i,j,(idx&1)===0,false));
    majors.forEach(([i,j],idx)=>add(i,j,(idx&1)===0,true));
    edgeLoads = new Array(curves.length).fill(0);
  }

  function rebuild(){
    const r = fitCanvas(lines); fitCanvas(fx);
    W=r.w; H=r.h;

    // подгоняем маску
    maskCanvas.width = Math.floor(W);
    maskCanvas.height= Math.floor(H);
    maskCtx.setTransform(1,0,0,1,0,0);
    maskCtx.clearRect(0,0,W,H);

    // contain
    const ir = maskImg.width/maskImg.height, br=W/H;
    let dw=W, dh=H, dx=0, dy=0;
    if (ir>br){ dh = Math.round(W/ir); dy = Math.round((H-dh)/2); }
    else      { dw = Math.round(H*ir); dx = Math.round((W-dw)/2); }
    maskCtx.drawImage(maskImg, 0,0, maskImg.width,maskImg.height, dx,dy,dw,dh);

    // 1) хабы
    pts = [];
    HUBS.forEach(h=>{
      const x=Math.round(h.x*W), y=Math.round(h.y*H);
      pts.push({x:insideMask(x,y)?x:clamp(x,1,W-2), y:insideMask(x,y)?y:clamp(y,1,H-2), core:true});
    });

    // 2) сетка по всей карте
    const step = Math.max(12, CFG.GRID_STEP_PX|0);
    const jitter = Math.round(step*0.35);
    for (let yy=step/2; yy<H; yy+=step){
      for (let xx=step/2; xx<W; xx+=step){
        const jx = clamp(xx + (Math.random()*2-1)*jitter, 1, W-2);
        const jy = clamp(yy + (Math.random()*2-1)*jitter, 1, H-2);
        if (insideMask(jx,jy)) pts.push({x:jx, y:jy, core:false});
        if (pts.length>=CFG.MAX_POINTS) break;
      }
      if (pts.length>=CFG.MAX_POINTS) break;
    }

    // kNN
    const N=pts.length, k=Math.max(3, CFG.K_NEAREST);
    const maxD = Math.max(110, Math.min(W,H)*.22);
    const m = new Map(), key=(a,b)=>a<b?`${a}_${b}`:`${b}_${a}`;
    for (let i=0;i<N;i++){
      const arr=[];
      for (let j=0;j<N;j++){
        if (i===j) continue;
        const d=Math.hypot(pts[i].x-pts[j].x, pts[i].y-pts[j].y);
        if (d<=maxD) arr.push({j,d});
      }
      arr.sort((a,b)=>a.d-b.d);
      for (let t=0;t<Math.min(k,arr.length);t++) m.set(key(i,arr[t].j), [i,arr[t].j]);
    }
    // магистрали
    BACKBONE.forEach(([a,b])=>m.set(key(a,b), [a,b,'major']));

    edges=[]; majors=[];
    m.forEach(v=>{ if(v[2]) majors.push([v[0],v[1]]); else edges.push([v[0],v[1]]); });

    precomputeCurves();
    drawStatic();
    initParticles();
  }

  function drawStatic(){
    const {width, height} = lines.getBoundingClientRect();
    lctx.clearRect(0,0,width,height);
    lctx.lineCap='round';

    lctx.lineWidth = 1;
    lctx.strokeStyle = 'rgba(230,230,230,.24)';
    for (let c of curves){
      if (c.major) continue;
      lctx.beginPath(); lctx.moveTo(c.A.x, c.A.y);
      lctx.quadraticCurveTo(c.C.x, c.C.y, c.B.x, c.B.y);
      lctx.stroke();
    }

    lctx.lineWidth = 1.6;
    lctx.strokeStyle = 'rgba(255,255,255,.58)';
    for (let c of curves){
      if (!c.major) continue;
      lctx.beginPath(); lctx.moveTo(c.A.x, c.A.y);
      lctx.quadraticCurveTo(c.C.x, c.C.y, c.B.x, c.B.y);
      lctx.stroke();
    }

    // хабы
    lctx.fillStyle='rgba(255,255,255,.95)';
    for (let i=0;i<Math.min(HUBS.length, pts.length);i++){
      const p=pts[i]; lctx.beginPath(); lctx.arc(p.x,p.y,2.4,0,Math.PI*2); lctx.fill();
    }
  }

  // балансный выбор ребра
  function pickCurveBalanced() {
    if (!curves.length) return null;
    let minLoad = Infinity;
    for (let i=0;i<curves.length;i++) if (edgeLoads[i] < minLoad) minLoad = edgeLoads[i];
    const candidates = [];
    for (let i=0;i<curves.length;i++) if (edgeLoads[i] === minLoad) candidates.push(i);
    const idx = candidates[(Math.random()*candidates.length)|0];
    return { curve: curves[idx], index: idx };
  }

  function spawnParticle(){
    const pick = pickCurveBalanced();
    const c = pick ? pick.curve : curves[(Math.random()*curves.length)|0];
    const ci = pick ? pick.index : curves.indexOf(c);
    if (ci>=0) edgeLoads[ci]++;

    return {
      ci, c,
      t: Math.random(),
      dir: Math.random()<.5 ? 1 : -1,
      s: CFG.SPEED_MIN + Math.random()*(CFG.SPEED_MAX-CFG.SPEED_MIN),
      r: 1.8 + Math.random()*1.2
    };
  }

  function initParticles(){
    edgeLoads = new Array(curves.length).fill(0);
    particles = [];
    for (let i=0;i<CFG.PARTICLES;i++) particles.push(spawnParticle());
    pulses = [];
  }

  const quadPoint=(A,C,B,t)=>{const u=1-t; return {x:u*u*A.x+2*u*t*C.x+t*t*B.x, y:u*u*A.y+2*u*t*C.y+t*t*B.y};};

  function step(dt){
    const k = Math.min(1, dt/1000);
    for (let p of particles){
      p.t += p.s * k * .30 * p.dir;
      if (p.t>=1 || p.t<=0){
        const end = p.t>=1 ? p.c.B : p.c.A;
        pulses.push({x:end.x, y:end.y, r:0, life:1});
        if (typeof p.ci === 'number') edgeLoads[p.ci] = Math.max(0, edgeLoads[p.ci]-1);
        Object.assign(p, spawnParticle());
      }
    }
    for (let i=pulses.length-1;i>=0;i--){
      const pl = pulses[i];
      pl.r   += CFG.END_FLASH_RADIUS * k;
      pl.life-= CFG.END_FLASH_FADE * k;
      if (pl.life<=0) pulses.splice(i,1);
    }
  }

  function drawFX(){
    const {width, height} = fx.getBoundingClientRect();
    fctx.clearRect(0,0,width,height);

    // частицы
    for (let p of particles){
      const pt = quadPoint(p.c.A, p.c.C, p.c.B, Math.min(1,Math.max(0,p.t)));
      const glowR = 3 + p.r*1.1;
      const g = fctx.createRadialGradient(pt.x,pt.y,0, pt.x,pt.y, glowR);
      g.addColorStop(0,'rgba(255,255,255,.14)');
      g.addColorStop(1,'rgba(255,255,255,0)');
      fctx.fillStyle=g; fctx.beginPath(); fctx.arc(pt.x,pt.y,glowR,0,Math.PI*2); fctx.fill();

      fctx.fillStyle='rgba(255,255,255,1)';
      fctx.beginPath(); fctx.arc(pt.x,pt.y,p.r,0,Math.PI*2); fctx.fill();
    }

    // вспышки
    fctx.globalCompositeOperation='screen';
    for (let pl of pulses){
      fctx.fillStyle = `rgba(255,255,255,${0.85*pl.life})`;
      fctx.beginPath(); fctx.arc(pl.x,pl.y, Math.max(2, 2.4*pl.life), 0, Math.PI*2); fctx.fill();

      const g = fctx.createRadialGradient(pl.x,pl.y,0, pl.x,pl.y, pl.r);
      g.addColorStop(0, `rgba(255,255,255,${0.65*pl.life})`);
      g.addColorStop(1, 'rgba(255,255,255,0)');
      fctx.fillStyle=g; fctx.beginPath(); fctx.arc(pl.x,pl.y,pl.r,0,Math.PI*2); fctx.fill();
    }
    fctx.globalCompositeOperation='source-over';
  }

  // цикл
  let prev = performance.now();
  function loop(now){
    const dt = now - prev; prev = now;
    if (ready){ step(dt); drawFX(); }
    requestAnimationFrame(loop);
  }

  function rebuildAll(){
    if (!maskImg.complete) return;
    ready=false; rebuild(); ready=true;
  }

  maskImg.onload  = () => { rebuildAll(); requestAnimationFrame(loop); };
  maskImg.onerror = () => {
    maskCanvas.width = 800; maskCanvas.height = 450;
    maskCtx.fillStyle='#fff'; maskCtx.fillRect(0,0,800,450);
    rebuildAll(); requestAnimationFrame(loop);
  };

  let tmr=null;
  const ro = new ResizeObserver(()=>{ clearTimeout(tmr); tmr=setTimeout(rebuildAll,120); });
  ro.observe(lines); ro.observe(fx);

  // логин
  const form = document.getElementById('loginForm');
  form.addEventListener('submit', e => {
    e.preventDefault();
    const login = document.getElementById('login').value.trim().toLowerCase();
    const pass  = document.getElementById('password').value.trim();
    const msgBox = document.getElementById('welcome-msg') || (() => {
      const el = document.createElement('div');
      el.id = 'welcome-msg';
      el.style.marginTop = '14px';
      el.style.fontSize = '15px';
      el.style.color = '#b8d7ff';
      form.insertAdjacentElement('afterend', el);
      return el;
    })();

    if (!login || !pass) {
      msgBox.textContent = 'Введите логин и пароль';
      msgBox.style.color = '#ff8080';
      return;
    }
    if (login === 'admin' && pass === '1234') {
      msgBox.textContent = 'Добро пожаловать, Админ!'; msgBox.style.color = '#b8ffb8';
      localStorage.setItem('user','admin');
      setTimeout(()=>location.href='/app/',1000);
    } else if (login === 'test' && pass === '1234') {
      msgBox.textContent = 'Добро пожаловать, Тест!'; msgBox.style.color = '#b8d7ff';
      localStorage.setItem('user','test');
      setTimeout(()=>location.href='/guest/',1000);
    } else {
      msgBox.textContent = 'Неверный логин или пароль'; msgBox.style.color = '#ff8080';
    }
  });

  // ДЕМО: ставим роль и форсим переход в /guest/
  document.getElementById('demoLink')?.addEventListener('click', (e) => {
    e.preventDefault();
    try { localStorage.setItem('user','guest'); } catch(e){}
    location.href = '/guest/';
  });

})(); /* IIFE */
</script>
</body>
</html>
